<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMWS - ê³µêµ° ì‘ì „ ê¸°ìƒ ì§€ì› ì‹œìŠ¤í…œ</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>

<!-- í†µí•© ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="navbar navbar-dark bg-dark border-bottom border-secondary mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            âœˆï¸ AMWS (Air Mission Weather System)
        </span>
        <div class="d-flex gap-2">
            <a href="/amws/" class="btn btn-sm btn-primary">ëŒ€ì‹œë³´ë“œ</a>
            <a href="/amws/map" class="btn btn-sm btn-outline-light">ì§€ë„</a>
            <a href="/amws/mission-matrix" class="btn btn-sm btn-outline-light">ì‘ì „í‘œ</a>
            <a href="/amws/monitor" class="btn btn-sm btn-outline-light">ëª¨ë‹ˆí„°</a>
        </div>
        <span class="text-secondary small">UNCLASSIFIED</span>
    </div>
</nav>

<div class="container">
    <!-- ë¹ ë¥¸ ì ‘ê·¼ ë²„íŠ¼ ì„¹ì…˜ ì¶”ê°€ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <h5 class="card-title text-light mb-3">ğŸš€ ë¹ ë¥¸ ì ‘ê·¼</h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="/amws/map" class="btn btn-lg btn-success w-100" style="height: 100px;">
                                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                    <span style="font-size: 2em;">ğŸ—ºï¸</span>
                                    <span class="mt-2">ì§€ë„ ë³´ê¸°</span>
                                    <small class="text-light opacity-75">ë¹„í–‰ì¥ ìœ„ì¹˜ ë° ê¸°ìƒ</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/amws/mission-matrix" class="btn btn-lg btn-info w-100" style="height: 100px;">
                                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                    <span style="font-size: 2em;">ğŸ“Š</span>
                                    <span class="mt-2">ì‘ì „ ê°€ëŠ¥ í˜„í™©</span>
                                    <small class="text-light opacity-75">ë§¤íŠ¸ë¦­ìŠ¤ í…Œì´ë¸”</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/amws/monitor" class="btn btn-lg btn-warning w-100" style="height: 100px;">
                                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                    <span style="font-size: 2em;">ğŸ“¡</span>
                                    <span class="mt-2">API ëª¨ë‹ˆí„°</span>
                                    <small class="text-dark opacity-75">ë°ì´í„° ìˆ˜ì‹  ìƒíƒœ</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="#analysisForm" class="btn btn-lg btn-primary w-100" style="height: 100px;">
                                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                    <span style="font-size: 2em;">ğŸ¯</span>
                                    <span class="mt-2">ì„ë¬´ ë¶„ì„</span>
                                    <small class="text-light opacity-75">ê°œë³„ íŒì •</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div class="row mb-4" id="analysisForm">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">Mission Configuration</div>
                <div class="card-body">
                    <form id="analysisForm" class="row g-3 align-items-center">
                        <div class="col-md-4">
                            <label for="baseSelect" class="form-label text-secondary">Base (ë¹„í–‰ì¥)</label>
                            <select class="form-select bg-dark text-light border-secondary" id="baseSelect">
                                {% for base in bases %}
                                <option value="{{ base[0] }}">{{ base[0] }} - {{ base[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="aircraftSelect" class="form-label text-secondary">Asset (í•­ê³µìì‚°)</label>
                            <select class="form-select bg-dark text-light border-secondary" id="aircraftSelect">
                                {% for ac in aircrafts %}
                                <option value="{{ ac[0] }}">{{ ac[0] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 text-end">
                            <label class="form-label d-block">&nbsp;</label>
                            <button type="button" class="btn btn-primary w-50" onclick="analyze()">Analyze</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ê²°ê³¼ ëŒ€ì‹œë³´ë“œ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div id="dashboardResult" style="display: none;">
        <div class="row">
            <!-- ì¢Œì¸¡: ì¢…í•© íŒì • -->
            <div class="col-md-4">
                <div class="status-box">
                    <div class="data-label mb-2">MISSION STATUS</div>
                    <div id="statusText" class="status-big">GO</div>
                    <div id="statusReason" class="mt-3 text-start small text-warning"></div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <span class="data-label">Base</span>
                            <span id="resBaseName" class="fw-bold">-</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="data-label">Obs Time</span>
                            <span id="resTime">-</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="data-label">Weather</span>
                            <span id="resWeather" class="badge bg-secondary">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìš°ì¸¡: ìƒì„¸ ìš”ì†Œ ë¶„ì„ -->
            <div class="col-md-8">
                <div class="row">
                    <!-- ì¸¡í’ ë¶„ì„ -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header text-center">Crosswind</div>
                            <div class="card-body text-center">
                                <div class="data-value" id="resXwind">0 kt</div>
                                <div class="small text-secondary mb-2">Limit: <span id="limXwind">30</span> kt</div>

                                <!-- Bar Graph -->
                                <div class="progress" style="height: 5px; background-color: #333;">
                                    <div id="barXwind" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>

                                <hr class="border-secondary">
                                <div class="text-start small text-secondary">
                                    Wind: <span id="resWindRaw" class="text-light"></span><br>
                                    Rwy Hdg: <span id="resRwyRaw" class="text-light"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì‹œì • ë¶„ì„ -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header text-center">Visibility</div>
                            <div class="card-body text-center">
                                <div class="data-value" id="resVis">9999 m</div>
                                <div class="small text-secondary mb-2">Min: <span id="limVis">800</span> m</div>

                                <div class="progress" style="height: 5px; background-color: #333;">
                                    <div id="barVis" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ìš´ê³  ë¶„ì„ -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header text-center">Ceiling</div>
                            <div class="card-body text-center">
                                <div class="data-value" id="resCeil">30000 ft</div>
                                <div class="small text-secondary mb-2">Min: <span id="limCeil">200</span> ft</div>

                                <div class="progress" style="height: 5px; background-color: #333;">
                                    <div id="barCeil" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript Logic -->
<script>
async function analyze() {
    const baseId = document.getElementById('baseSelect').value;
    const aircraftId = document.getElementById('aircraftSelect').value;

    const response = await fetch('/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ base_id: baseId, aircraft_id: aircraftId })
    });

    const data = await response.json();

    if (data.error) {
        alert(data.error);
        return;
    }

    // UI í‘œì‹œ
    document.getElementById('dashboardResult').style.display = 'block';

    // 1. ì¢…í•© íŒì • ì—…ë°ì´íŠ¸
    const statusEl = document.getElementById('statusText');
    statusEl.innerText = data.status;
    statusEl.className = 'status-big text-' + data.status_color;

    // NO-GO ì‚¬ìœ  ì¶œë ¥
    const reasonEl = document.getElementById('statusReason');
    if (data.reasons.length > 0) {
        reasonEl.innerHTML = 'ğŸš« ' + data.reasons.join('<br>ğŸš« ');
    } else {
        reasonEl.innerHTML = 'âœ… All Parameters Normal';
    }

    // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('resBaseName').innerText = data.base_name;
    document.getElementById('resTime').innerText = data.obs_time;
    document.getElementById('resWeather').innerText = data.weather_desc;

    // 2. ìˆ˜ì¹˜ ë°ì´í„° ë° ë°” ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
    // (1) Crosswind
    updateCard('Xwind', data.crosswind, data.limits.xwind, true); // true: ê°’ì´ ì‘ì„ìˆ˜ë¡ ì¢‹ìŒ (ì¸¡í’)
    document.getElementById('resWindRaw').innerText = data.wind_info;
    document.getElementById('resRwyRaw').innerText = data.rwy_info;

    // (2) Visibility
    updateCard('Vis', data.visibility, data.limits.vis, false); // false: ê°’ì´ í´ìˆ˜ë¡ ì¢‹ìŒ

    // (3) Ceiling
    updateCard('Ceil', data.ceiling, data.limits.ceil, false);
}

function updateCard(id, current, limit, isLowerBetter) {
    // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById('res' + id).innerText = current;
    document.getElementById('lim' + id).innerText = limit;

    // ë°” ê·¸ë˜í”„ í¼ì„¼íŠ¸ ê³„ì‚°
    let percent = 0;
    let color = 'bg-success';

    if (isLowerBetter) {
        // ì¸¡í’: ì œí•œì¹˜ë³´ë‹¤ ë‚®ì•„ì•¼ í•¨
        percent = (current / limit) * 100;
        if (current > limit) color = 'bg-danger';
        else if (current > limit * 0.8) color = 'bg-warning';
    } else {
        // ì‹œì •/ìš´ê³ : ì œí•œì¹˜ë³´ë‹¤ ë†’ì•„ì•¼ í•¨
        // ì‹œê°í™”ë¥¼ ìœ„í•´ limitì˜ 2ë°°ë¥¼ 100%ë¡œ ì¡ìŒ (ë‹¨ìˆœí™”)
        let maxRef = limit * 3;
        percent = (current / maxRef) * 100;
        if (current < limit) color = 'bg-danger';
        else if (current < limit * 1.5) color = 'bg-warning';
    }

    if (percent > 100) percent = 100;

    const bar = document.getElementById('bar' + id);
    bar.style.width = percent + '%';
    bar.className = 'progress-bar ' + color;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ë¶„ì„ (ì²« ë²ˆì§¸ ì˜µì…˜ìœ¼ë¡œ)
window.onload = function() {
    // analyze();
};
</script>

</body>
</html>
