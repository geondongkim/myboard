<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMWS - 공군 작전 기상 지원 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* 네비게이션 */
        .navbar {
            background: rgba(15, 32, 39, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-btn {
            transition: all 0.3s ease;
            border-radius: 8px !important;
            font-weight: 600;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* 빠른 접근 카드 */
        .quick-access-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }
        
        .quick-access-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .quick-btn {
            height: 140px;
            border-radius: 15px;
            border: none;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            font-weight: 600;
        }
        
        .quick-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .quick-btn:hover::before {
            left: 100%;
        }
        
        .quick-btn:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }
        
        .quick-btn-icon {
            font-size: 3em;
            margin-bottom: 10px;
            display: block;
        }
        
        .quick-btn-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
        }
        
        .quick-btn-subtitle {
            font-size: 0.85rem;
            opacity: 0.85;
        }
        
        .btn-map {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-matrix {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-monitor {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-analyze {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        /* 미션 구성 카드 */
        .mission-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 25px;
            border-radius: 15px 15px 0 0;
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin: -30px -30px 20px -30px;
        }
        
        .form-label {
            color: #a0aec0;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .form-select, .form-control {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #fff !important;
            border-radius: 10px !important;
            padding: 12px 15px !important;
            transition: all 0.3s ease;
        }
        
        .form-select:focus, .form-control:focus {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25) !important;
        }
        
        .form-select option {
            background: #1a202c;
            color: #fff;
        }
        
        .btn-analyze-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 40px;
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-analyze-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        /* 결과 대시보드 */
        .status-box {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .data-label {
            color: #a0aec0;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-big {
            font-size: 3.5rem;
            font-weight: 900;
            margin: 15px 0;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        
        .text-success {
            color: #43e97b !important;
        }
        
        .text-danger {
            color: #f5576c !important;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-header-mini {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            font-weight: 700;
            margin: -25px -25px 15px -25px;
            font-size: 1rem;
        }
        
        .data-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: #fff;
            margin: 15px 0;
        }
        
        .progress {
            height: 8px !important;
            border-radius: 10px !important;
            background-color: rgba(255, 255, 255, 0.1) !important;
            margin: 15px 0;
        }
        
        .progress-bar {
            border-radius: 10px !important;
            transition: width 0.6s ease;
        }
        
        .badge {
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* 애니메이션 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .container > * {
            animation: fadeInUp 0.6s ease-out;
        }
        
        /* 반응형 */
        @media (max-width: 768px) {
            .quick-btn {
                height: 120px;
            }
            .quick-btn-icon {
                font-size: 2em;
            }
            .status-big {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>

<!-- 네비게이션 바 -->
<nav class="navbar navbar-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
            <i class="fas fa-plane-departure"></i> AMWS
        </span>
        <div class="d-flex gap-2">
            <a href="/amws/" class="btn btn-sm btn-primary nav-btn">
                <i class="fas fa-tachometer-alt"></i> 대시보드
            </a>
            <a href="/amws/map" class="btn btn-sm btn-outline-light nav-btn">
                <i class="fas fa-map-marked-alt"></i> 지도
            </a>
            <a href="/amws/mission-matrix" class="btn btn-sm btn-outline-light nav-btn">
                <i class="fas fa-table"></i> 작전표
            </a>
            <a href="/amws/monitor" class="btn btn-sm btn-outline-light nav-btn">
                <i class="fas fa-wifi"></i> 모니터
            </a>
        </div>
        <span class="text-secondary small">
            <i class="fas fa-shield-alt"></i> UNCLASSIFIED
        </span>
    </div>
</nav>

<div class="container">
    <!-- 빠른 접근 섹션 -->
    <div class="quick-access-card">
        <h2 class="quick-access-title">
            <i class="fas fa-rocket"></i> 빠른 접근
        </h2>
        <div class="row g-4">
            <div class="col-md-3">
                <a href="/amws/map" class="btn quick-btn btn-map w-100">
                    <span class="quick-btn-icon"><i class="fas fa-map-marked-alt"></i></span>
                    <span class="quick-btn-title">지도 보기</span>
                    <span class="quick-btn-subtitle">비행장 위치 및 기상</span>
                </a>
            </div>
            <div class="col-md-3">
                <a href="/amws/mission-matrix" class="btn quick-btn btn-matrix w-100">
                    <span class="quick-btn-icon"><i class="fas fa-table"></i></span>
                    <span class="quick-btn-title">작전 현황</span>
                    <span class="quick-btn-subtitle">매트릭스 테이블</span>
                </a>
            </div>
            <div class="col-md-3">
                <a href="/amws/monitor" class="btn quick-btn btn-monitor w-100">
                    <span class="quick-btn-icon"><i class="fas fa-wifi"></i></span>
                    <span class="quick-btn-title">API 모니터</span>
                    <span class="quick-btn-subtitle">데이터 수신 상태</span>
                </a>
            </div>
            <div class="col-md-3">
                <a href="#analysisForm" class="btn quick-btn btn-analyze w-100">
                    <span class="quick-btn-icon"><i class="fas fa-crosshairs"></i></span>
                    <span class="quick-btn-title">임무 분석</span>
                    <span class="quick-btn-subtitle">개별 판정</span>
                </a>
            </div>
        </div>
    </div>

    <!-- 지도 섹션 -->
    <div class="mission-card" id="mapSection">
        <div class="card-header-custom">
            <i class="fas fa-map-marked-alt"></i> Mission Map Overview
        </div>
        <div style="height: 600px; border-radius: 10px; overflow: hidden;">
            {{ map_html|safe }}
        </div>
        <div class="text-center mt-3">
            <a href="/amws/map" class="btn btn-outline-light">
                <i class="fas fa-expand-arrows-alt"></i> 전체 화면으로 보기
            </a>
        </div>
    </div>

    <!-- 임무 분석 패널 -->
    <div class="mission-card" id="analysisForm">
        <div class="card-header-custom">
            <i class="fas fa-sliders-h"></i> Mission Analysis Tool
        </div>
        <form class="row g-4 align-items-end">
            <div class="col-md-5">
                <label for="baseSelect" class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Base (비행장)
                </label>
                <select class="form-select" id="baseSelect">
                    {% for base in bases %}
                    <option value="{{ base[0] }}">{{ base[0] }} - {{ base[1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label for="aircraftSelect" class="form-label">
                    <i class="fas fa-fighter-jet"></i> Asset (항공자산)
                </label>
                <select class="form-select" id="aircraftSelect">
                    {% for ac in aircrafts %}
                    <option value="{{ ac[0] }}">{{ ac[0] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-analyze-action w-100" onclick="analyze()">
                    <i class="fas fa-search"></i> Analyze
                </button>
            </div>
        </form>
    </div>

    <!-- 결과 대시보드 -->
    <div id="dashboardResult" style="display: none;">
        <div class="row g-4">
            <!-- 종합 판정 -->
            <div class="col-md-4">
                <div class="status-box">
                    <div class="data-label mb-2">
                        <i class="fas fa-clipboard-check"></i> MISSION STATUS
                    </div>
                    <div id="statusText" class="status-big">GO</div>
                    <div id="statusReason" class="mt-3 text-start small text-warning"></div>
                </div>

                <div class="info-card mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="data-label"><i class="fas fa-home"></i> Base</span>
                        <span id="resBaseName" class="fw-bold text-white">-</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="data-label"><i class="fas fa-clock"></i> Obs Time</span>
                        <span id="resTime" class="text-white">-</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="data-label"><i class="fas fa-cloud"></i> Weather</span>
                        <span id="resWeather" class="badge bg-secondary">-</span>
                    </div>
                </div>
            </div>

            <!-- 상세 요소 분석 -->
            <div class="col-md-8">
                <div class="row g-4">
                    <!-- 측풍 -->
                    <div class="col-md-4">
                        <div class="data-card">
                            <div class="card-header-mini">
                                <i class="fas fa-wind"></i> Crosswind
                            </div>
                            <div class="text-center">
                                <div class="data-value" id="resXwind">0 kt</div>
                                <div class="small text-secondary mb-2">
                                    Limit: <span id="limXwind">30</span> kt
                                </div>
                                <div class="progress">
                                    <div id="barXwind" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                                <hr style="border-color: rgba(255,255,255,0.1);">
                                <div class="text-start small text-secondary">
                                    Wind: <span id="resWindRaw" class="text-light"></span><br>
                                    Rwy Hdg: <span id="resRwyRaw" class="text-light"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 시정 -->
                    <div class="col-md-4">
                        <div class="data-card">
                            <div class="card-header-mini">
                                <i class="fas fa-eye"></i> Visibility
                            </div>
                            <div class="text-center">
                                <div class="data-value" id="resVis">9999 m</div>
                                <div class="small text-secondary mb-2">
                                    Min: <span id="limVis">800</span> m
                                </div>
                                <div class="progress">
                                    <div id="barVis" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 운고 -->
                    <div class="col-md-4">
                        <div class="data-card">
                            <div class="card-header-mini">
                                <i class="fas fa-cloud-sun"></i> Ceiling
                            </div>
                            <div class="text-center">
                                <div class="data-value" id="resCeil">30000 ft</div>
                                <div class="small text-secondary mb-2">
                                    Min: <span id="limCeil">200</span> ft
                                </div>
                                <div class="progress">
                                    <div id="barCeil" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 시간대별 추세 차트 추가 -->
        <div class="mission-card mt-4">
            <div class="card-header-custom">
                <i class="fas fa-chart-line"></i> 24시간 기상 추세 분석
            </div>
            <div style="height: 400px; position: relative;">
                <canvas id="trendChart"></canvas>
            </div>
            <div class="alert alert-info mt-3" style="background: rgba(79, 172, 254, 0.1); border: 1px solid rgba(79, 172, 254, 0.3); color: #4facfe;">
                <i class="fas fa-info-circle"></i> 
                <strong>차트 해석:</strong> 측풍이 제한선(점선) 아래에 있고 시정/운고가 충분할 때 작전 가능합니다. 
                범례를 클릭하여 시정/운고 데이터를 표시/숨김 할 수 있습니다.
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN 추가 (</body> 위에) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- JavaScript 전체 교체 -->
<script>
let trendChart = null;

async function analyze() {
    const baseId = document.getElementById('baseSelect').value;
    const aircraftId = document.getElementById('aircraftSelect').value;

    const response = await fetch('/amws/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ base_id: baseId, aircraft_id: aircraftId })
    });

    const data = await response.json();

    if (data.error) {
        alert(data.error);
        return;
    }

    // 결과 섹션 표시
    document.getElementById('dashboardResult').style.display = 'block';
    document.getElementById('dashboardResult').scrollIntoView({ behavior: 'smooth' });

    // 상태 업데이트
    const statusEl = document.getElementById('statusText');
    statusEl.innerText = data.status;
    statusEl.className = 'status-big text-' + data.status_color;

    const reasonEl = document.getElementById('statusReason');
    if (data.reasons.length > 0) {
        reasonEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + data.reasons.join('<br><i class="fas fa-exclamation-triangle"></i> ');
    } else {
        reasonEl.innerHTML = '<i class="fas fa-check-circle"></i> All Parameters Normal';
    }

    document.getElementById('resBaseName').innerText = data.base_name;
    document.getElementById('resTime').innerText = data.obs_time;
    document.getElementById('resWeather').innerText = data.weather_desc;

    // 현재 값 카드 업데이트
    const crosswindValue = parseFloat(data.crosswind);
    const visibilityValue = parseInt(data.visibility);
    const ceilingValue = parseInt(data.ceiling);

    updateCard('Xwind', crosswindValue, data.limits.xwind, true);
    document.getElementById('resWindRaw').innerText = data.wind_info;
    document.getElementById('resRwyRaw').innerText = data.rwy_info;

    updateCard('Vis', visibilityValue, data.limits.vis, false);
    updateCard('Ceil', ceilingValue, data.limits.ceil, false);

    // 차트 생성
    createTrendChart(data.chart, aircraftId);
}

function updateCard(id, current, limit, isLowerBetter) {
    document.getElementById('res' + id).innerText = current + (id === 'Xwind' ? ' kt' : (id === 'Vis' ? ' m' : ' ft'));
    document.getElementById('lim' + id).innerText = limit;

    let percent = 0;
    let color = 'bg-success';

    if (isLowerBetter) {
        percent = (current / limit) * 100;
        if (current > limit) color = 'bg-danger';
        else if (current > limit * 0.8) color = 'bg-warning';
    } else {
        let maxRef = limit * 3;
        percent = (current / maxRef) * 100;
        if (current < limit) color = 'bg-danger';
        else if (current < limit * 1.5) color = 'bg-warning';
    }

    if (percent > 100) percent = 100;

    const bar = document.getElementById('bar' + id);
    bar.style.width = percent + '%';
    bar.className = 'progress-bar ' + color;
}

function createTrendChart(chartData, aircraftId) {
    const ctx = document.getElementById('trendChart');
    
    // 기존 차트 제거
    if (trendChart) {
        trendChart.destroy();
    }

    // GO/NO-GO 배경 영역 생성
    const backgroundColors = chartData.status.map(s => s === 1 ? 'rgba(67, 233, 123, 0.1)' : 'rgba(245, 87, 108, 0.1)');

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: '측풍 (kt)',
                    data: chartData.crosswind,
                    borderColor: 'rgb(102, 126, 234)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    yAxisID: 'y1'
                },
                {
                    label: '측풍 제한',
                    data: Array(chartData.labels.length).fill(chartData.limits.crosswind),
                    borderColor: 'rgba(245, 87, 108, 0.5)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    yAxisID: 'y1'
                },
                {
                    label: '시정 (m)',
                    data: chartData.visibility,
                    borderColor: 'rgb(79, 172, 254)',
                    backgroundColor: 'rgba(79, 172, 254, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    yAxisID: 'y2',
                    hidden: true
                },
                {
                    label: '운고 (ft)',
                    data: chartData.ceiling,
                    borderColor: 'rgb(67, 233, 123)',
                    backgroundColor: 'rgba(67, 233, 123, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    yAxisID: 'y3',
                    hidden: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                title: {
                    display: true,
                    text: `${aircraftId} - 24시간 기상 추세 및 작전 가능 시간대`,
                    color: '#fff',
                    font: { size: 16, weight: 'bold' }
                },
                legend: {
                    labels: { color: '#e0e0e0' }
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const idx = context.dataIndex;
                            return chartData.status[idx] === 1 ? '✅ GO' : '❌ NO-GO';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#e0e0e0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y1: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: '측풍 (kt)', color: '#e0e0e0' },
                    ticks: { color: '#e0e0e0' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: '시정 (m)', color: '#e0e0e0' },
                    ticks: { color: '#e0e0e0' },
                    grid: { display: false }
                },
                y3: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: '운고 (ft)', color: '#e0e0e0' },
                    ticks: { color: '#e0e0e0' },
                    grid: { display: false }
                }
            }
        }
    });
}
</script>

</body>
</html>
